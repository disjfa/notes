<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx | Full-stack web development notes.</title>
    <meta name="description" content="Full-stack web development notes.">
    
    
    <link rel="preload" href="/notes/assets/css/0.styles.69480afa.css" as="style"><link rel="preload" href="/notes/assets/js/app.b2f0b337.js" as="script"><link rel="preload" href="/notes/assets/js/2.1225d179.js" as="script"><link rel="preload" href="/notes/assets/js/39.474b3651.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.ad79507a.js"><link rel="prefetch" href="/notes/assets/js/11.c1cf1b66.js"><link rel="prefetch" href="/notes/assets/js/12.13036d52.js"><link rel="prefetch" href="/notes/assets/js/13.7938725b.js"><link rel="prefetch" href="/notes/assets/js/14.1de88fe6.js"><link rel="prefetch" href="/notes/assets/js/15.8efffe63.js"><link rel="prefetch" href="/notes/assets/js/16.6e436b02.js"><link rel="prefetch" href="/notes/assets/js/17.19a8b946.js"><link rel="prefetch" href="/notes/assets/js/18.ee0c949d.js"><link rel="prefetch" href="/notes/assets/js/19.4b320e7c.js"><link rel="prefetch" href="/notes/assets/js/20.08ab0b67.js"><link rel="prefetch" href="/notes/assets/js/21.b99757f6.js"><link rel="prefetch" href="/notes/assets/js/22.00f309fb.js"><link rel="prefetch" href="/notes/assets/js/23.ce26102d.js"><link rel="prefetch" href="/notes/assets/js/24.b0410150.js"><link rel="prefetch" href="/notes/assets/js/25.8d753f87.js"><link rel="prefetch" href="/notes/assets/js/26.18e891e6.js"><link rel="prefetch" href="/notes/assets/js/27.7d7999d4.js"><link rel="prefetch" href="/notes/assets/js/28.9774fd5a.js"><link rel="prefetch" href="/notes/assets/js/29.c8a41031.js"><link rel="prefetch" href="/notes/assets/js/3.50d7592f.js"><link rel="prefetch" href="/notes/assets/js/30.97f18ff4.js"><link rel="prefetch" href="/notes/assets/js/31.1a22d7ad.js"><link rel="prefetch" href="/notes/assets/js/32.3111817b.js"><link rel="prefetch" href="/notes/assets/js/33.6efec194.js"><link rel="prefetch" href="/notes/assets/js/34.dda5567c.js"><link rel="prefetch" href="/notes/assets/js/35.40a56c44.js"><link rel="prefetch" href="/notes/assets/js/36.458d1789.js"><link rel="prefetch" href="/notes/assets/js/37.9e76c86f.js"><link rel="prefetch" href="/notes/assets/js/38.ea35f119.js"><link rel="prefetch" href="/notes/assets/js/4.5850f364.js"><link rel="prefetch" href="/notes/assets/js/40.9b2812bd.js"><link rel="prefetch" href="/notes/assets/js/41.b2ed6f89.js"><link rel="prefetch" href="/notes/assets/js/42.bedea5a6.js"><link rel="prefetch" href="/notes/assets/js/43.52d01c0b.js"><link rel="prefetch" href="/notes/assets/js/44.bf6db40e.js"><link rel="prefetch" href="/notes/assets/js/45.a6ddf2fb.js"><link rel="prefetch" href="/notes/assets/js/46.ccf7223f.js"><link rel="prefetch" href="/notes/assets/js/47.6b608624.js"><link rel="prefetch" href="/notes/assets/js/48.02d66f09.js"><link rel="prefetch" href="/notes/assets/js/49.35cdabf7.js"><link rel="prefetch" href="/notes/assets/js/5.4fdd094a.js"><link rel="prefetch" href="/notes/assets/js/50.8e046486.js"><link rel="prefetch" href="/notes/assets/js/51.c23cdab9.js"><link rel="prefetch" href="/notes/assets/js/52.a0c473fb.js"><link rel="prefetch" href="/notes/assets/js/53.9d5c6032.js"><link rel="prefetch" href="/notes/assets/js/54.279ef24c.js"><link rel="prefetch" href="/notes/assets/js/55.f263bef6.js"><link rel="prefetch" href="/notes/assets/js/56.e689e4b6.js"><link rel="prefetch" href="/notes/assets/js/6.04dbe20d.js"><link rel="prefetch" href="/notes/assets/js/7.64d3e5cf.js"><link rel="prefetch" href="/notes/assets/js/8.a6fbdd51.js"><link rel="prefetch" href="/notes/assets/js/9.0b25e1bc.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.69480afa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">Full-stack web development notes.</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/8483/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/8483/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/notes/" class="sidebar-link">Introduction</a></li><li><a href="/notes/topics/algos.html" class="sidebar-link">Algos</a></li><li><a href="/notes/topics/bash.html" class="sidebar-link">Bash</a></li><li><a href="/notes/topics/dom.html" class="sidebar-link">Dom</a></li><li><a href="/notes/topics/express.html" class="sidebar-link">Express</a></li><li><a href="/notes/topics/mssql.html" class="sidebar-link">Mssql</a></li><li><a href="/notes/topics/raspberrypi.html" class="sidebar-link">Raspberrypi</a></li><li><a href="/notes/topics/testing.html" class="sidebar-link">Testing</a></li><li><a href="/notes/topics/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/notes/topics/ansible.html" class="sidebar-link">Ansible</a></li><li><a href="/notes/topics/caching.html" class="sidebar-link">Caching</a></li><li><a href="/notes/topics/electricity.html" class="sidebar-link">Electricity</a></li><li><a href="/notes/topics/filesystem.html" class="sidebar-link">Filesystem</a></li><li><a href="/notes/topics/mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/notes/topics/react.html" class="sidebar-link">React</a></li><li><a href="/notes/topics/tmux.html" class="sidebar-link">Tmux</a></li><li><a href="/notes/topics/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/notes/topics/compression.html" class="sidebar-link">Compression</a></li><li><a href="/notes/topics/electronics.html" class="sidebar-link">Electronics</a></li><li><a href="/notes/topics/fp.html" class="sidebar-link">Fp</a></li><li><a href="/notes/topics/networking.html" class="sidebar-link">Networking</a></li><li><a href="/notes/topics/restful.html" class="sidebar-link">Restful</a></li><li><a href="/notes/topics/users.html" class="sidebar-link">Users</a></li><li><a href="/notes/topics/arduino.html" class="sidebar-link">Arduino</a></li><li><a href="/notes/topics/config.html" class="sidebar-link">Config</a></li><li><a href="/notes/topics/electron.html" class="sidebar-link">Electron</a></li><li><a href="/notes/topics/git.html" class="sidebar-link">Git</a></li><li><a href="/notes/topics/nginx.html" class="active sidebar-link">Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#command-line" class="sidebar-link">Command Line</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#terminology" class="sidebar-link">Terminology</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#mime-types" class="sidebar-link">mime.types</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#simplest-server" class="sidebar-link">Simplest server</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#static-server-with-custom-configuration" class="sidebar-link">Static server with custom configuration</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#location-blocks" class="sidebar-link">Location Blocks</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#serving-files" class="sidebar-link">Serving Files</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#logging" class="sidebar-link">Logging</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#inheritance" class="sidebar-link">Inheritance</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#testing" class="sidebar-link">Testing</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#ssl-https" class="sidebar-link">SSL/HTTPS</a></li><li class="sidebar-sub-header"><a href="/notes/topics/nginx.html#node-reverse-proxy" class="sidebar-link">Node Reverse Proxy</a></li></ul></li><li><a href="/notes/topics/rfid.html" class="sidebar-link">Rfid</a></li><li><a href="/notes/topics/vagrant.html" class="sidebar-link">Vagrant</a></li><li><a href="/notes/topics/async.html" class="sidebar-link">Async</a></li><li><a href="/notes/topics/csharp.html" class="sidebar-link">Csharp</a></li><li><a href="/notes/topics/elm.html" class="sidebar-link">Elm</a></li><li><a href="/notes/topics/javascript.html" class="sidebar-link">Javascript</a></li><li><a href="/notes/topics/nodemcu.html" class="sidebar-link">Nodemcu</a></li><li><a href="/notes/topics/security.html" class="sidebar-link">Security</a></li><li><a href="/notes/topics/vim.html" class="sidebar-link">Vim</a></li><li><a href="/notes/topics/babel.html" class="sidebar-link">Babel</a></li><li><a href="/notes/topics/css.html" class="sidebar-link">Css</a></li><li><a href="/notes/topics/es6.html" class="sidebar-link">Es6</a></li><li><a href="/notes/topics/linux.html" class="sidebar-link">Linux</a></li><li><a href="/notes/topics/node.html" class="sidebar-link">Node</a></li><li><a href="/notes/topics/ssh.html" class="sidebar-link">Ssh</a></li><li><a href="/notes/topics/vm.html" class="sidebar-link">Vm</a></li><li><a href="/notes/topics/base.html" class="sidebar-link">Base</a></li><li><a href="/notes/topics/docker.html" class="sidebar-link">Docker</a></li><li><a href="/notes/topics/excel.html" class="sidebar-link">Excel</a></li><li><a href="/notes/topics/mobile.html" class="sidebar-link">Mobile</a></li><li><a href="/notes/topics/oop.html" class="sidebar-link">Oop</a></li><li><a href="/notes/topics/systemd.html" class="sidebar-link">Systemd</a></li><li><a href="/notes/topics/vscode.html" class="sidebar-link">Vscode</a></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="nginx"><a href="#nginx" aria-hidden="true" class="header-anchor">#</a> Nginx</h1> <p>It only knows about static content. While it can serve static HTML, for dynamically generated HTML, it has to offload requests to other processes in order to generate HTML. Ex. User requests a PHP file, and nginx sends it to an interpreter, which then returns the HTML, which is sent back by nginx.</p> <p>Nginx communicates with the PHP interpreter via a <strong>unix socket</strong> file. Nginx communicates with the website visitor via a <strong>TCP socket</strong> file.</p> <p>To access a guest (VM) nginx from a host, set a port forwarding in Virtualbox with name <code>nginx</code>, host port <code>80</code>, guest port <code>80</code>.</p> <h1 id="install"><a href="#install" aria-hidden="true" class="header-anchor">#</a> Install</h1> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">apt-get</span> update <span class="token comment"># Refresh packages list.</span>
<span class="token function">apt-get</span> <span class="token function">install</span> nginx <span class="token comment"># Install the web server.</span>
</code></pre></div><p>If we want to add modules, we need to compile nginx from source and add them during the compilation phase.</p> <h1 id="configuration"><a href="#configuration" aria-hidden="true" class="header-anchor">#</a> Configuration</h1> <p><code>/usr/share/nginx/html/</code> has the index.html file.</p> <p><code>nginx -t</code> - After changes, check the syntax and run a test to make sure the web-server will work.</p> <p><code>systemctl reload nginx</code> - Load the changes because the server is running with the old config file. Otherwise use <code>service nginx reload</code>.</p> <p><code>/etc/nginx/nginx.conf</code> is the main server configuration file. For each site we run, a separate file is needed, unless we want to run just one site.</p> <p>Specific site configurations must be placed in the <code>/etc/nginx/conf.d/</code> folder. These override any <code>nginx.conf</code> settings. These are loaded by the default <code>include /etc/nginx/conf.d/*.conf;</code> line in the main .conf file.</p> <p><code>http {}</code> block - For all incoming http requests, use these settings.</p> <h2 id="command-line"><a href="#command-line" aria-hidden="true" class="header-anchor">#</a> Command Line</h2> <p>The default location nginx looks in for the configuration file is <code>/etc/nginx/nginx.conf</code>, but you can pass in an arbitrary path with the <code>-c</code> flag. Ex. <code>nginx -c /usr/local/nginx/conf</code>.</p> <div class="language-Bash extra-class"><pre class="language-bash"><code>nginx -c <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> -t   <span class="token comment"># Test configuration at absolute path</span>
nginx -c <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span>      <span class="token comment"># Start with a custom configuration.</span>
nginx -s <span class="token operator">&lt;</span>signal<span class="token operator">&gt;</span>    <span class="token comment"># Stop or reload.</span>
</code></pre></div><h2 id="terminology"><a href="#terminology" aria-hidden="true" class="header-anchor">#</a> Terminology</h2> <p><code>Blocks</code> - Sections to which directives are applied. Also called context or scope. They can be nested. The most important ones are <code>main</code>, <code>http</code>, <code>server</code> and <code>location</code> (for matching URI locations on incoming requests to parent server context)<br> <code>Vhost</code> - Virtual host. Defined in the <code>http</code> block.</p> <p><code>Directives</code> - Specific configuration options composed of an option name and option value. Ex. <code>Listen 80</code>. There are 4 types:</p> <ul><li><strong>Standard</strong> directive. Defined once, unless turned off elsewhere. <code>gzip on</code>.</li> <li><strong>Array</strong> directive. Can be defined multiple times with different flags. <code>access_log logs/access.log</code> vs <code>access_log logs/access_notice.log notice;</code> in the same context.</li> <li><strong>Action</strong> directive. Perform an action when hit <code>rewrite</code>, <code>return</code>.</li> <li><strong>try_files</strong> directive. <code>try_files $uri index.html =404</code> tries finding a file and if not found, server index.html. If that also fails, send a 404 error.</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>               <span class="token comment"># Block start</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>         <span class="token comment"># Directive</span>
<span class="token punctuation">}</span>                      <span class="token comment"># Block end</span>
</code></pre></div><h2 id="mime-types"><a href="#mime-types" aria-hidden="true" class="header-anchor">#</a> mime.types</h2> <p>If this file is not included in the <code>http</code> block, all the different files will be served as simple text files and thus won't be rendered. Intead of writing all cases like <code>http { text/html html; text/css css;}</code> we can simply include a list of them with <code>http { include mime.types; }</code>.</p> <h2 id="simplest-server"><a href="#simplest-server" aria-hidden="true" class="header-anchor">#</a> Simplest server</h2> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                            <span class="token comment"># Needed to be a valid conf file.</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>              <span class="token comment"># Recognize filetypes.</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>      <span class="token comment"># Should be domain name.</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token operator">/</span>template<span class="token punctuation">;</span>       <span class="token comment"># Match URIs to files here.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>After that, reload with <code>systemctl reload nginx</code>.</p> <h2 id="static-server-with-custom-configuration"><a href="#static-server-with-custom-configuration" aria-hidden="true" class="header-anchor">#</a> Static server with custom configuration</h2> <p><strong>nginx.conf</strong></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span> <span class="token comment"># Path needs to be absolute.</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">8080</span><span class="token punctuation">;</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>app<span class="token operator">/</span>public<span class="token punctuation">;</span> <span class="token comment"># index.html is inside public.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Useful commands</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Check if nginx is running.</span>
systemctl status nginx

<span class="token comment"># Start nginx if not.</span>
systemctl start nginx

<span class="token comment"># Reload nginx.</span>
systemctl restart nginx

<span class="token comment"># Start a server with this custom configuration.</span>
<span class="token function">sudo</span> nginx -c /home/user/elm-seed/nginx.conf

<span class="token comment"># Reload custom configuration after changes.</span>
<span class="token function">sudo</span> nginx -s reload

<span class="token comment"># Show nginx processes.</span>
<span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> nginx

<span class="token comment"># Kill a server with a PID 2847.</span>
<span class="token function">kill</span> -9 2847
</code></pre></div><h2 id="location-blocks"><a href="#location-blocks" aria-hidden="true" class="header-anchor">#</a> Location Blocks</h2> <p>The most used context block in any nginx configuration, which defines the behavior of specific URIs or requests. Think of them as intercepting a request based on its value and doing something else than serving to a client.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token operator">/</span>template<span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span>example <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;Hello from location block!&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="serving-files"><a href="#serving-files" aria-hidden="true" class="header-anchor">#</a> Serving Files</h2> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token comment"># The files are available at domain.com/files/file.ext</span>
        <span class="token comment"># The location is appended to the specified root path for the full location.</span>
        <span class="token keyword">location</span> <span class="token operator">/</span>files<span class="token operator">/</span> <span class="token punctuation">{</span>
            <span class="token comment"># The files need to be inside /home/username/files/</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>username<span class="token punctuation">;</span>
            <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="matching-uris-to-location-blocks"><a href="#matching-uris-to-location-blocks" aria-hidden="true" class="header-anchor">#</a> Matching URIs to Location Blocks</h4> <p>In order of importance. Matching occurs for everything past the value. <code>location /greet</code> will match <code>/greetings/something</code></p> <ol><li><code>=</code> - Exact match.</li> <li><code>^~</code> - Preferential prefix. Same as standard (prefix), but more important than regex.</li> <li><code>~</code> or <code>~*</code> - Regex case sensitive or insensitive.</li> <li><code>no modifier</code> - Prefix standard match.</li></ol> <p>Example for <code>/greet</code>:</p> <ol><li><code>= /greet</code> - Match <strong>only</strong> /greet.</li> <li><code>^~</code> - Override the standard match if it also happens.</li> <li><code>~* /greet[0-9]</code> - Match /greet123, /greet456 etc.</li> <li><code>no modifier</code> - Match /greet, /greeting etc.</li></ol> <h4 id="try-files"><a href="#try-files" aria-hidden="true" class="header-anchor">#</a> try_files</h4> <p>The example below sets up a location outside of the regular server root. When someone visits <code>domain/downloads/file</code> they would get the wanted file.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token operator">/</span>template<span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span>downloads <span class="token punctuation">{</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token punctuation">;</span>
            <span class="token keyword">try_files</span> <span class="token comment">#uri =404;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="logging"><a href="#logging" aria-hidden="true" class="header-anchor">#</a> Logging</h2> <p>There are two types of logs by default, located in <code>/var/log/nginx</code>.</p> <ol><li><strong>Error</strong> logs for anything that went wrong.</li> <li><strong>Access</strong> logs for all requests made.</li></ol> <p>If we want specific logs for specific context, we can do that by using <code>error_log /var/log/nginx/log_name.log debug;</code>.</p> <p>Also, we can disable logs for certain locations by using <code>access_log off</code> or <code>error_log off</code>. This is useful for saving resources, ex. for all .css requests.</p> <h2 id="inheritance"><a href="#inheritance" aria-hidden="true" class="header-anchor">#</a> Inheritance</h2> <p>Http &gt; Server &gt; Location</p> <p>It only works for standard and array directives. It doesn't work for action and try_files directives as the stop the flow and are immediately executed.</p> <h2 id="testing"><a href="#testing" aria-hidden="true" class="header-anchor">#</a> Testing</h2> <p><code>curl -I http://127.0.0.1/css/bootstrap.css</code> - Request the response headers of a resource.</p> <h1 id="optimization"><a href="#optimization" aria-hidden="true" class="header-anchor">#</a> Optimization</h1> <p>Further reading on these topics:</p> <ul><li>Expires headers. Client side caching.</li> <li>Gzip. Compression.</li> <li>FastCGI cache. Cache backend responses.</li> <li>Limiting. Prevent DDoS.</li> <li>GeoIP. Location of requests and limits.</li> <li>HTTP2. One client-server connection vs 10+ individual requests.</li></ul> <h1 id="security"><a href="#security" aria-hidden="true" class="header-anchor">#</a> Security</h1> <p>Here are some of the steps for hardening an nginx server:</p> <ul><li>Remove unused modules. Can only be done while compiling from source.</li> <li>Turn off server tokens with <code>server_tokens off;</code>. This hides the nginx version.</li> <li>Set buffer sizes to prevent buffer overflow attacks.</li> <li>Block user agents. Prevents indexing and scraping.</li> <li>Configure X-frame-options. Tells when it's ok to server to an iframe.</li></ul> <h2 id="ssl-https"><a href="#ssl-https" aria-hidden="true" class="header-anchor">#</a> SSL/HTTPS</h2> <p>After purchasing an SSL certificate, two files are obtained.</p> <ul><li><code>.crt</code> certificate file.</li> <li><code>.key</code> certificate key file.</li></ul> <p>We place these files into <code>/etc/nginx/ssl/</code> and use this configuration in the server/domain block.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SSL/HTTPS uses the <code>443</code> port vs the standard HTTP <code>80</code>.</p> <h4 id="let-s-encrypt"><a href="#let-s-encrypt" aria-hidden="true" class="header-anchor">#</a> Let's Encrypt</h4> <p>Certbot is used for generating certificates and automating their renewal.</p> <h1 id="proxy-vs-reverse-proxy"><a href="#proxy-vs-reverse-proxy" aria-hidden="true" class="header-anchor">#</a> Proxy vs Reverse Proxy</h1> <p><strong>Normal:</strong> Client &gt; Server<br> <strong>Proxy:</strong> Client &gt; Proxy &gt; Server</p> <p>Used to hide the origin of the request.</p> <p><strong>Normal:</strong> Client &gt; App<br> <strong>Reverse Proxy:</strong> Client &gt; Server &gt; App</p> <p>Used to prevent direct access to app i.e. exploit bad code.</p> <p>To run any Linux server on port 80, you need to be running as root. If you want to run node directly on port 80, that means you have to run node as root. If your application has any security flaws, it will become significantly compounded by the fact that it has access to do <em>anything it wants</em>. For example, if you write something that accidentally allows the user to read arbitrary files, now they can read files from other server user's accounts.</p> <p>If you use nginx in front of node, you can run your node as a limited user on port 3000 (or whatever) and then have nginx run as root on port 80, forwarding requests to port 3000. Now the node application is limited to the user permissions you give it.</p> <p>It's always better to use nginx as a proxy for a node.js server; nginx can proxy to a number of node backends and should any of them die can fail-over automatically with the benefit that, if there is an issue with the node interpreter (for instance while upgrading) and it stops responding, it can serve a fall-back HTML page.</p> <p>Additionally, you shouldn't be using node.js for serving &quot;static&quot; files such as images, js/css files, etc. Use node.js for the complex stuff and let nginx take care of the things it's good at - serving files from the disk or from a cache.</p> <h2 id="node-reverse-proxy"><a href="#node-reverse-proxy" aria-hidden="true" class="header-anchor">#</a> Node Reverse Proxy</h2> <p>Any request made to the server on the <code>80</code> port is forwarded to <code>http://localhost:3000</code>, as if it was made directly there.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">events</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            <span class="token keyword">proxy_pass</span> <span class="token string">'http://localhost:3000/'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="important"><a href="#important" aria-hidden="true" class="header-anchor">#</a> Important</h4> <p><strong>Any changes made to</strong> <code>nginx.conf</code> <strong>need to be reloaded with</strong> <code>sudo nginx -s reload</code> <strong>for them to work!!!</strong></p> <p>It is crucial to note the usage of the <strong>trailing slash</strong>. This is called a <strong>proxy path</strong>. Unless we specify one, nginx assumes the original request path i.e. location. It is <strong>recommended</strong> to <strong>use</strong> the proxy path / trailing slash.</p> <p><a href="https://stackoverflow.com/questions/32542282/how-do-i-rewrite-urls-in-a-proxy-response-in-nginx" target="_blank" rel="noopener noreferrer">Stack Overflow explanation.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>foo<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>With</strong> trailing slash, the request for <code>http://localhost:3000/foo/bar/baz</code> will be proxied to <code>http://localhost:3000/bar/baz</code>. Basically, <code>/foo/</code> gets replaced by <code>/</code> to change the request path from <code>/foo/bar/baz</code> to <code>/bar/baz</code>.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>foo <span class="token punctuation">{</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Without</strong> trailing slash, the same request will be proxied to <code>http://localhost:3000/foo/bar/baz</code>. Basically, the full original request path gets passed on without changes.</p> <p>For example, a request to <code>http://localhost:8000/app/users</code> (with the config below) would return all users because the request made to the server is actually <code>http://localhost:3000/api/users</code>.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">8000</span><span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">/</span>app<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">proxy_pass</span> <span class="token string">'http://localhost:3000/api/users'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="caching"><a href="#caching" aria-hidden="true" class="header-anchor">#</a> Caching</h1> <p>Reusing page renders after they have been loaded once. Instead of everyone making a request, running a script, fetching data from the database, rendering a page and sending a response, only the first one does the work, the results is cached in a database (for a certain amount of time), and everyone that wants the same is simply given the results from the database. <strong>Useful for static content, not so much for dynamic i.e. web apps.</strong></p> <p>Caching is also possible on the client side, by specifying certain HTTP headers (ETags, Last-Modified).</p> <p>POST requests should not be cached.</p> <p>Caching problems can be identified by appending a parameter at the end of the URL which bypasses the caching. <code>www.example.com/posts/1?test</code></p> <h1 id="compression"><a href="#compression" aria-hidden="true" class="header-anchor">#</a> Compression</h1> <p>Using <code>gzip</code> can greatly reduce the traffic by compressing text files (not images) like HTML, CSS, JS, XML, which use verbose bloated formats.</p> <p>Done in <code>/etc/nginx/nginx.conf</code> (trickles down to all site-specific configs in <code>/etc/nginx/conf.d/SITEFILE</code>)</p> <p><code>gzip on</code> - Enable compression.<br> <code>gzip_min_length 512</code> - Only compress files bigger than 512 bytes.<br> <code>gzip_types text/plain application/javascript text/html text/css;</code> - Formats to compress.<br> <code>gzip_vary</code> - Sends vary header.</p> <p>It's important to use the <code>Vary</code> option in order to prevent compressed and non-compressed responses from interfering with each other i.e. two browsers download gzipped content, while only one supports it, resulting in only it being cached, making that response unusable to other non-supporting browsers.</p> <h1 id="php-interpreter-setup"><a href="#php-interpreter-setup" aria-hidden="true" class="header-anchor">#</a> PHP Interpreter Setup</h1> <p>Nginx only understands static files. It doesn't know how to handle code. For that, we use an interpreter (sits behind the web-server), which communicates with nginx via a socket file.</p> <ol><li><code>apt-get install php-mysql php-fpm</code>. - Install the interpreter.
<ul><li><strong>FastCGI Process Manager</strong> is used to create a pool of PHP interpreter processes waiting to deal with web-server requests. Without this, there would be only one process which would handle requests one by one, resulting in long wait times.</li></ul></li> <li><code>apt-get install php-json php-xmlrpc php-curl php-gd php-xml</code> - Install extra extensions needed for Wordpress.</li> <li><code>mkdir /var/run/php-fpm</code> - Create directory for php-fpm sockets (webserver -&gt; PHP)</li> <li><code>ls /etc/php/7.0/fpm/pool.d</code> - Check if the pool configurations directory exists. If not, create it.</li> <li>Configure <code>/etc/php/7.0/fpm/php-fpm.conf</code>:
<ul><li>Make a backup copy.</li> <li>Add <strong>just</strong> the following inside:<div class="language- extra-class"><pre class="language-text"><code>[global]
pid = /run/php-fpm.pid
error_log = /var/log/php-fpm.log
include = /etc/php/fpm/pool.d/*.conf
</code></pre></div></li></ul></li> <li>Create a default pool configuration in <code>/etc/php/7.0/fpm/pool.d/www.conf</code>:
<ul><li>Make a backup copy.</li> <li>Add <strong>just</strong> the following inside to define a private socket between nginx and the interpreter i.e. www-data from nginx communicates with www-data from fpm:<div class="language- extra-class"><pre class="language-text"><code>[default]
security.limit_extensions = .php
listen = /var/run/php/yourserverhostname.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660
user = www-data
group = www-data
pm = dynamic
pm.max_children = 75
pm.start_servers = 8
pm.min_spare_servers = 5
pm.max_spare_servers = 20
pm.max_requests = 500
</code></pre></div></li></ul></li> <li>Edit the top level php.ini file in <code>/etc/php/7.0/fpm/php.ini</code>:
<ul><li>Make a backup copy.</li> <li>Add <strong>just</strong> the following inside:<div class="language- extra-class"><pre class="language-text"><code>[PHP]
engine = On
short_open_tag = Off
asp_tags = Off
precision = 14
output_buffering = 4096
zlib.output_compression = Off
implicit_flush = Off
unserialize_callback_func =
serialize_precision = 17
disable_functions =
disable_classes =
zend.enable_gc = On
expose_php = Off
max_execution_time = 30
max_input_time = 60
memory_limit = 128M
error_reporting = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT
display_errors = Off
display_startup_errors = Off
log_errors = On
log_errors_max_len = 1024
ignore_repeated_errors = Off
ignore_repeated_source = Off
report_memleaks = On
track_errors = Off
html_errors = On
variables_order = &quot;GPCS&quot;
request_order = &quot;GP&quot;
register_argc_argv = Off
auto_globals_jit = On
post_max_size = 8M
auto_prepend_file =
auto_append_file =
default_mimetype = &quot;text/html&quot;
default_charset = &quot;UTF-8&quot;
doc_root =
user_dir =
enable_dl = Off
cgi.fix_pathinfo=0
file_uploads = On
upload_max_filesize = 25M
max_file_uploads = 20
allow_url_fopen = On
allow_url_include = Off
default_socket_timeout = 60
[CLI Server]
cli_server.color = On
[Date]
[filter]
[iconv]
[intl]
[sqlite]
[sqlite3]
[Pcre]
[Pdo]
[Pdo_mysql]
pdo_mysql.cache_size = 2000
pdo_mysql.default_socket=
[Phar]
[mail function]
SMTP = localhost
smtp_port = 25
mail.add_x_header = On
[SQL]
sql.safe_mode = Off
[ODBC]
odbc.allow_persistent = On
odbc.check_persistent = On
odbc.max_persistent = -1
odbc.max_links = -1
odbc.defaultlrl = 4096
odbc.defaultbinmode = 1
[Interbase]
ibase.allow_persistent = 1
ibase.max_persistent = -1
ibase.max_links = -1
ibase.timestampformat = &quot;%Y-%m-%d %H:%M:%S&quot;
ibase.dateformat = &quot;%Y-%m-%d&quot;
ibase.timeformat = &quot;%H:%M:%S&quot;
[MySQL]
mysql.allow_local_infile = On
mysql.allow_persistent = On
mysql.cache_size = 2000
mysql.max_persistent = -1
mysql.max_links = -1
mysql.default_port =
mysql.default_socket =
mysql.default_host =
mysql.default_user =
mysql.default_password =
mysql.connect_timeout = 60
mysql.trace_mode = Off
[MySQLi]
mysqli.max_persistent = -1
mysqli.allow_persistent = On
mysqli.max_links = -1
mysqli.cache_size = 2000
mysqli.default_port = 3306
mysqli.default_socket =
mysqli.default_host =
mysqli.default_user =
mysqli.default_pw =
mysqli.reconnect = Off
[mysqlnd]
mysqlnd.collect_statistics = On
mysqlnd.collect_memory_statistics = Off
[OCI8]
[PostgreSQL]
pgsql.allow_persistent = On
pgsql.auto_reset_persistent = Off
pgsql.max_persistent = -1
pgsql.max_links = -1
pgsql.ignore_notice = 0
pgsql.log_notice = 0
[Sybase-CT]
sybct.allow_persistent = On
sybct.max_persistent = -1
sybct.max_links = -1
sybct.min_server_severity = 10
sybct.min_client_severity = 10
[bcmath]
bcmath.scale = 0
[browscap]
[Session]
session.save_handler = files
session.use_strict_mode = 0
session.use_cookies = 1
session.use_only_cookies = 1
session.name = PHPSESSID
session.auto_start = 0
session.cookie_lifetime = 0
session.cookie_path = /
session.cookie_domain =
session.cookie_httponly =
session.serialize_handler = php
session.gc_probability = 1
session.gc_divisor = 1000
session.gc_maxlifetime = 1440
session.referer_check =
session.cache_limiter = nocache
session.cache_expire = 180
session.use_trans_sid = 0
session.hash_function = 0
session.hash_bits_per_character = 5
url_rewriter.tags = &quot;a=href,area=href,frame=src,input=src,form=fakeentry&quot;
[MSSQL]
mssql.allow_persistent = On
mssql.max_persistent = -1
mssql.max_links = -1
mssql.min_error_severity = 10
mssql.min_message_severity = 10
mssql.compatibility_mode = Off
mssql.secure_connection = Off
[Assertion]
[COM]
[mbstring]
[gd]
[exif]
[Tidy]
tidy.clean_output = Off
[soap]
soap.wsdl_cache_enabled=1
soap.wsdl_cache_dir=&quot;/tmp&quot;
soap.wsdl_cache_ttl=86400
soap.wsdl_cache_limit = 5
[sysvshm]
[ldap]
ldap.max_links = -1
[dba]
[opcache]
[curl]
[openssl]
</code></pre></div></li></ul></li> <li><code>cgi.fix_pathinfo=0</code> - <strong>Make sure this is set!</strong></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/notes/topics/git.html" class="prev">
          Git
        </a></span> <span class="next"><a href="/notes/topics/rfid.html">
          Rfid
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notes/assets/js/app.b2f0b337.js" defer></script><script src="/notes/assets/js/2.1225d179.js" defer></script><script src="/notes/assets/js/39.474b3651.js" defer></script>
  </body>
</html>
