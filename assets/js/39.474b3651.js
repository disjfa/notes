(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{266:function(e,t,s){"use strict";s.r(t);var n=s(2),a=Object(n.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx","aria-hidden":"true"}},[e._v("#")]),e._v(" Nginx")]),e._v(" "),s("p",[e._v("It only knows about static content. While it can serve static HTML, for dynamically generated HTML, it has to offload requests to other processes in order to generate HTML. Ex. User requests a PHP file, and nginx sends it to an interpreter, which then returns the HTML, which is sent back by nginx.")]),e._v(" "),s("p",[e._v("Nginx communicates with the PHP interpreter via a "),s("strong",[e._v("unix socket")]),e._v(" file. Nginx communicates with the website visitor via a "),s("strong",[e._v("TCP socket")]),e._v(" file.")]),e._v(" "),s("p",[e._v("To access a guest (VM) nginx from a host, set a port forwarding in Virtualbox with name "),s("code",[e._v("nginx")]),e._v(", host port "),s("code",[e._v("80")]),e._v(", guest port "),s("code",[e._v("80")]),e._v(".")]),e._v(" "),s("h1",{attrs:{id:"install"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install","aria-hidden":"true"}},[e._v("#")]),e._v(" Install")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" update "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Refresh packages list.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" nginx "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Install the web server.")]),e._v("\n")])])]),s("p",[e._v("If we want to add modules, we need to compile nginx from source and add them during the compilation phase.")]),e._v(" "),s("h1",{attrs:{id:"configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configuration","aria-hidden":"true"}},[e._v("#")]),e._v(" Configuration")]),e._v(" "),s("p",[s("code",[e._v("/usr/share/nginx/html/")]),e._v(" has the index.html file.")]),e._v(" "),s("p",[s("code",[e._v("nginx -t")]),e._v(" - After changes, check the syntax and run a test to make sure the web-server will work.")]),e._v(" "),s("p",[s("code",[e._v("systemctl reload nginx")]),e._v(" - Load the changes because the server is running with the old config file. Otherwise use "),s("code",[e._v("service nginx reload")]),e._v(".")]),e._v(" "),s("p",[s("code",[e._v("/etc/nginx/nginx.conf")]),e._v(" is the main server configuration file. For each site we run, a separate file is needed, unless we want to run just one site.")]),e._v(" "),s("p",[e._v("Specific site configurations must be placed in the "),s("code",[e._v("/etc/nginx/conf.d/")]),e._v(" folder. These override any "),s("code",[e._v("nginx.conf")]),e._v(" settings. These are loaded by the default "),s("code",[e._v("include /etc/nginx/conf.d/*.conf;")]),e._v(" line in the main .conf file.")]),e._v(" "),s("p",[s("code",[e._v("http {}")]),e._v(" block - For all incoming http requests, use these settings.")]),e._v(" "),s("h2",{attrs:{id:"command-line"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#command-line","aria-hidden":"true"}},[e._v("#")]),e._v(" Command Line")]),e._v(" "),s("p",[e._v("The default location nginx looks in for the configuration file is "),s("code",[e._v("/etc/nginx/nginx.conf")]),e._v(", but you can pass in an arbitrary path with the "),s("code",[e._v("-c")]),e._v(" flag. Ex. "),s("code",[e._v("nginx -c /usr/local/nginx/conf")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language-Bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("nginx -c "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("path"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" -t   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Test configuration at absolute path")]),e._v("\nnginx -c "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("path"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start with a custom configuration.")]),e._v("\nnginx -s "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("signal"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Stop or reload.")]),e._v("\n")])])]),s("h2",{attrs:{id:"terminology"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#terminology","aria-hidden":"true"}},[e._v("#")]),e._v(" Terminology")]),e._v(" "),s("p",[s("code",[e._v("Blocks")]),e._v(" - Sections to which directives are applied. Also called context or scope. They can be nested. The most important ones are "),s("code",[e._v("main")]),e._v(", "),s("code",[e._v("http")]),e._v(", "),s("code",[e._v("server")]),e._v(" and "),s("code",[e._v("location")]),e._v(" (for matching URI locations on incoming requests to parent server context)"),s("br"),e._v(" "),s("code",[e._v("Vhost")]),e._v(" - Virtual host. Defined in the "),s("code",[e._v("http")]),e._v(" block.")]),e._v(" "),s("p",[s("code",[e._v("Directives")]),e._v(" - Specific configuration options composed of an option name and option value. Ex. "),s("code",[e._v("Listen 80")]),e._v(". There are 4 types:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Standard")]),e._v(" directive. Defined once, unless turned off elsewhere. "),s("code",[e._v("gzip on")]),e._v(".")]),e._v(" "),s("li",[s("strong",[e._v("Array")]),e._v(" directive. Can be defined multiple times with different flags. "),s("code",[e._v("access_log logs/access.log")]),e._v(" vs "),s("code",[e._v("access_log logs/access_notice.log notice;")]),e._v(" in the same context.")]),e._v(" "),s("li",[s("strong",[e._v("Action")]),e._v(" directive. Perform an action when hit "),s("code",[e._v("rewrite")]),e._v(", "),s("code",[e._v("return")]),e._v(".")]),e._v(" "),s("li",[s("strong",[e._v("try_files")]),e._v(" directive. "),s("code",[e._v("try_files $uri index.html =404")]),e._v(" tries finding a file and if not found, server index.html. If that also fails, send a 404 error.")])]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("               "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Block start")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Directive")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("                      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Block end")]),e._v("\n")])])]),s("h2",{attrs:{id:"mime-types"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mime-types","aria-hidden":"true"}},[e._v("#")]),e._v(" mime.types")]),e._v(" "),s("p",[e._v("If this file is not included in the "),s("code",[e._v("http")]),e._v(" block, all the different files will be served as simple text files and thus won't be rendered. Intead of writing all cases like "),s("code",[e._v("http { text/html html; text/css css;}")]),e._v(" we can simply include a list of them with "),s("code",[e._v("http { include mime.types; }")]),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"simplest-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#simplest-server","aria-hidden":"true"}},[e._v("#")]),e._v(" Simplest server")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("                            "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Needed to be a valid conf file.")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("include")]),e._v(" mime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Recognize filetypes.")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server_name")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Should be domain name.")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("sites"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("template"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("       "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Match URIs to files here.")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("After that, reload with "),s("code",[e._v("systemctl reload nginx")]),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"static-server-with-custom-configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#static-server-with-custom-configuration","aria-hidden":"true"}},[e._v("#")]),e._v(" Static server with custom configuration")]),e._v(" "),s("p",[s("strong",[e._v("nginx.conf")])]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("include")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("mime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Path needs to be absolute.")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8080")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("app"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# index.html is inside public.")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[s("strong",[e._v("Useful commands")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Check if nginx is running.")]),e._v("\nsystemctl status nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start nginx if not.")]),e._v("\nsystemctl start nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Reload nginx.")]),e._v("\nsystemctl restart nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start a server with this custom configuration.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" nginx -c /home/user/elm-seed/nginx.conf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Reload custom configuration after changes.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" nginx -s reload\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Show nginx processes.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("ps")]),e._v(" -ef "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Kill a server with a PID 2847.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("kill")]),e._v(" -9 2847\n")])])]),s("h2",{attrs:{id:"location-blocks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#location-blocks","aria-hidden":"true"}},[e._v("#")]),e._v(" Location Blocks")]),e._v(" "),s("p",[e._v("The most used context block in any nginx configuration, which defines the behavior of specific URIs or requests. Think of them as intercepting a request based on its value and doing something else than serving to a client.")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("include")]),e._v(" mime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server_name")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("sites"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("template"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("example "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("200")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Hello from location block!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h2",{attrs:{id:"serving-files"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#serving-files","aria-hidden":"true"}},[e._v("#")]),e._v(" Serving Files")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("include")]),e._v(" mime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# The files are available at domain.com/files/file.ext")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# The location is appended to the specified root path for the full location.")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("files"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# The files need to be inside /home/username/files/")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("try_files")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$uri")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$uri")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("404")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h4",{attrs:{id:"matching-uris-to-location-blocks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#matching-uris-to-location-blocks","aria-hidden":"true"}},[e._v("#")]),e._v(" Matching URIs to Location Blocks")]),e._v(" "),s("p",[e._v("In order of importance. Matching occurs for everything past the value. "),s("code",[e._v("location /greet")]),e._v(" will match "),s("code",[e._v("/greetings/something")])]),e._v(" "),s("ol",[s("li",[s("code",[e._v("=")]),e._v(" - Exact match.")]),e._v(" "),s("li",[s("code",[e._v("^~")]),e._v(" - Preferential prefix. Same as standard (prefix), but more important than regex.")]),e._v(" "),s("li",[s("code",[e._v("~")]),e._v(" or "),s("code",[e._v("~*")]),e._v(" - Regex case sensitive or insensitive.")]),e._v(" "),s("li",[s("code",[e._v("no modifier")]),e._v(" - Prefix standard match.")])]),e._v(" "),s("p",[e._v("Example for "),s("code",[e._v("/greet")]),e._v(":")]),e._v(" "),s("ol",[s("li",[s("code",[e._v("= /greet")]),e._v(" - Match "),s("strong",[e._v("only")]),e._v(" /greet.")]),e._v(" "),s("li",[s("code",[e._v("^~")]),e._v(" - Override the standard match if it also happens.")]),e._v(" "),s("li",[s("code",[e._v("~* /greet[0-9]")]),e._v(" - Match /greet123, /greet456 etc.")]),e._v(" "),s("li",[s("code",[e._v("no modifier")]),e._v(" - Match /greet, /greeting etc.")])]),e._v(" "),s("h4",{attrs:{id:"try-files"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#try-files","aria-hidden":"true"}},[e._v("#")]),e._v(" try_files")]),e._v(" "),s("p",[e._v("The example below sets up a location outside of the regular server root. When someone visits "),s("code",[e._v("domain/downloads/file")]),e._v(" they would get the wanted file.")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("include")]),e._v(" mime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server_name")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("sites"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("template"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("downloads "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("root")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("sites"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("try_files")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#uri =404;")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h2",{attrs:{id:"logging"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#logging","aria-hidden":"true"}},[e._v("#")]),e._v(" Logging")]),e._v(" "),s("p",[e._v("There are two types of logs by default, located in "),s("code",[e._v("/var/log/nginx")]),e._v(".")]),e._v(" "),s("ol",[s("li",[s("strong",[e._v("Error")]),e._v(" logs for anything that went wrong.")]),e._v(" "),s("li",[s("strong",[e._v("Access")]),e._v(" logs for all requests made.")])]),e._v(" "),s("p",[e._v("If we want specific logs for specific context, we can do that by using "),s("code",[e._v("error_log /var/log/nginx/log_name.log debug;")]),e._v(".")]),e._v(" "),s("p",[e._v("Also, we can disable logs for certain locations by using "),s("code",[e._v("access_log off")]),e._v(" or "),s("code",[e._v("error_log off")]),e._v(". This is useful for saving resources, ex. for all .css requests.")]),e._v(" "),s("h2",{attrs:{id:"inheritance"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inheritance","aria-hidden":"true"}},[e._v("#")]),e._v(" Inheritance")]),e._v(" "),s("p",[e._v("Http > Server > Location")]),e._v(" "),s("p",[e._v("It only works for standard and array directives. It doesn't work for action and try_files directives as the stop the flow and are immediately executed.")]),e._v(" "),s("h2",{attrs:{id:"testing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#testing","aria-hidden":"true"}},[e._v("#")]),e._v(" Testing")]),e._v(" "),s("p",[s("code",[e._v("curl -I http://127.0.0.1/css/bootstrap.css")]),e._v(" - Request the response headers of a resource.")]),e._v(" "),s("h1",{attrs:{id:"optimization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#optimization","aria-hidden":"true"}},[e._v("#")]),e._v(" Optimization")]),e._v(" "),s("p",[e._v("Further reading on these topics:")]),e._v(" "),s("ul",[s("li",[e._v("Expires headers. Client side caching.")]),e._v(" "),s("li",[e._v("Gzip. Compression.")]),e._v(" "),s("li",[e._v("FastCGI cache. Cache backend responses.")]),e._v(" "),s("li",[e._v("Limiting. Prevent DDoS.")]),e._v(" "),s("li",[e._v("GeoIP. Location of requests and limits.")]),e._v(" "),s("li",[e._v("HTTP2. One client-server connection vs 10+ individual requests.")])]),e._v(" "),s("h1",{attrs:{id:"security"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#security","aria-hidden":"true"}},[e._v("#")]),e._v(" Security")]),e._v(" "),s("p",[e._v("Here are some of the steps for hardening an nginx server:")]),e._v(" "),s("ul",[s("li",[e._v("Remove unused modules. Can only be done while compiling from source.")]),e._v(" "),s("li",[e._v("Turn off server tokens with "),s("code",[e._v("server_tokens off;")]),e._v(". This hides the nginx version.")]),e._v(" "),s("li",[e._v("Set buffer sizes to prevent buffer overflow attacks.")]),e._v(" "),s("li",[e._v("Block user agents. Prevents indexing and scraping.")]),e._v(" "),s("li",[e._v("Configure X-frame-options. Tells when it's ok to server to an iframe.")])]),e._v(" "),s("h2",{attrs:{id:"ssl-https"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ssl-https","aria-hidden":"true"}},[e._v("#")]),e._v(" SSL/HTTPS")]),e._v(" "),s("p",[e._v("After purchasing an SSL certificate, two files are obtained.")]),e._v(" "),s("ul",[s("li",[s("code",[e._v(".crt")]),e._v(" certificate file.")]),e._v(" "),s("li",[s("code",[e._v(".key")]),e._v(" certificate key file.")])]),e._v(" "),s("p",[e._v("We place these files into "),s("code",[e._v("/etc/nginx/ssl/")]),e._v(" and use this configuration in the server/domain block.")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("443")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ssl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ssl_certificate")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ssl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("crt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ssl_certificate_key")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ssl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("SSL/HTTPS uses the "),s("code",[e._v("443")]),e._v(" port vs the standard HTTP "),s("code",[e._v("80")]),e._v(".")]),e._v(" "),s("h4",{attrs:{id:"let-s-encrypt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#let-s-encrypt","aria-hidden":"true"}},[e._v("#")]),e._v(" Let's Encrypt")]),e._v(" "),s("p",[e._v("Certbot is used for generating certificates and automating their renewal.")]),e._v(" "),s("h1",{attrs:{id:"proxy-vs-reverse-proxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#proxy-vs-reverse-proxy","aria-hidden":"true"}},[e._v("#")]),e._v(" Proxy vs Reverse Proxy")]),e._v(" "),s("p",[s("strong",[e._v("Normal:")]),e._v(" Client > Server"),s("br"),e._v(" "),s("strong",[e._v("Proxy:")]),e._v(" Client > Proxy > Server")]),e._v(" "),s("p",[e._v("Used to hide the origin of the request.")]),e._v(" "),s("p",[s("strong",[e._v("Normal:")]),e._v(" Client > App"),s("br"),e._v(" "),s("strong",[e._v("Reverse Proxy:")]),e._v(" Client > Server > App")]),e._v(" "),s("p",[e._v("Used to prevent direct access to app i.e. exploit bad code.")]),e._v(" "),s("p",[e._v("To run any Linux server on port 80, you need to be running as root. If you want to run node directly on port 80, that means you have to run node as root. If your application has any security flaws, it will become significantly compounded by the fact that it has access to do "),s("em",[e._v("anything it wants")]),e._v(". For example, if you write something that accidentally allows the user to read arbitrary files, now they can read files from other server user's accounts.")]),e._v(" "),s("p",[e._v("If you use nginx in front of node, you can run your node as a limited user on port 3000 (or whatever) and then have nginx run as root on port 80, forwarding requests to port 3000. Now the node application is limited to the user permissions you give it.")]),e._v(" "),s("p",[e._v("It's always better to use nginx as a proxy for a node.js server; nginx can proxy to a number of node backends and should any of them die can fail-over automatically with the benefit that, if there is an issue with the node interpreter (for instance while upgrading) and it stops responding, it can serve a fall-back HTML page.")]),e._v(" "),s("p",[e._v("Additionally, you shouldn't be using node.js for serving \"static\" files such as images, js/css files, etc. Use node.js for the complex stuff and let nginx take care of the things it's good at - serving files from the disk or from a cache.")]),e._v(" "),s("h2",{attrs:{id:"node-reverse-proxy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-reverse-proxy","aria-hidden":"true"}},[e._v("#")]),e._v(" Node Reverse Proxy")]),e._v(" "),s("p",[e._v("Any request made to the server on the "),s("code",[e._v("80")]),e._v(" port is forwarded to "),s("code",[e._v("http://localhost:3000")]),e._v(", as if it was made directly there.")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("events")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("proxy_pass")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'http://localhost:3000/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h4",{attrs:{id:"important"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#important","aria-hidden":"true"}},[e._v("#")]),e._v(" Important")]),e._v(" "),s("p",[s("strong",[e._v("Any changes made to")]),e._v(" "),s("code",[e._v("nginx.conf")]),e._v(" "),s("strong",[e._v("need to be reloaded with")]),e._v(" "),s("code",[e._v("sudo nginx -s reload")]),e._v(" "),s("strong",[e._v("for them to work!!!")])]),e._v(" "),s("p",[e._v("It is crucial to note the usage of the "),s("strong",[e._v("trailing slash")]),e._v(". This is called a "),s("strong",[e._v("proxy path")]),e._v(". Unless we specify one, nginx assumes the original request path i.e. location. It is "),s("strong",[e._v("recommended")]),e._v(" to "),s("strong",[e._v("use")]),e._v(" the proxy path / trailing slash.")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://stackoverflow.com/questions/32542282/how-do-i-rewrite-urls-in-a-proxy-response-in-nginx",target:"_blank",rel:"noopener noreferrer"}},[e._v("Stack Overflow explanation."),s("OutboundLink")],1)]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("foo"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("proxy_pass")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3000")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[s("strong",[e._v("With")]),e._v(" trailing slash, the request for "),s("code",[e._v("http://localhost:3000/foo/bar/baz")]),e._v(" will be proxied to "),s("code",[e._v("http://localhost:3000/bar/baz")]),e._v(". Basically, "),s("code",[e._v("/foo/")]),e._v(" gets replaced by "),s("code",[e._v("/")]),e._v(" to change the request path from "),s("code",[e._v("/foo/bar/baz")]),e._v(" to "),s("code",[e._v("/bar/baz")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("foo "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("proxy_pass")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[s("strong",[e._v("Without")]),e._v(" trailing slash, the same request will be proxied to "),s("code",[e._v("http://localhost:3000/foo/bar/baz")]),e._v(". Basically, the full original request path gets passed on without changes.")]),e._v(" "),s("p",[e._v("For example, a request to "),s("code",[e._v("http://localhost:8000/app/users")]),e._v(" (with the config below) would return all users because the request made to the server is actually "),s("code",[e._v("http://localhost:3000/api/users")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("server")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("listen")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("location")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("app"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("proxy_pass")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'http://localhost:3000/api/users'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h1",{attrs:{id:"caching"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#caching","aria-hidden":"true"}},[e._v("#")]),e._v(" Caching")]),e._v(" "),s("p",[e._v("Reusing page renders after they have been loaded once. Instead of everyone making a request, running a script, fetching data from the database, rendering a page and sending a response, only the first one does the work, the results is cached in a database (for a certain amount of time), and everyone that wants the same is simply given the results from the database. "),s("strong",[e._v("Useful for static content, not so much for dynamic i.e. web apps.")])]),e._v(" "),s("p",[e._v("Caching is also possible on the client side, by specifying certain HTTP headers (ETags, Last-Modified).")]),e._v(" "),s("p",[e._v("POST requests should not be cached.")]),e._v(" "),s("p",[e._v("Caching problems can be identified by appending a parameter at the end of the URL which bypasses the caching. "),s("code",[e._v("www.example.com/posts/1?test")])]),e._v(" "),s("h1",{attrs:{id:"compression"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#compression","aria-hidden":"true"}},[e._v("#")]),e._v(" Compression")]),e._v(" "),s("p",[e._v("Using "),s("code",[e._v("gzip")]),e._v(" can greatly reduce the traffic by compressing text files (not images) like HTML, CSS, JS, XML, which use verbose bloated formats.")]),e._v(" "),s("p",[e._v("Done in "),s("code",[e._v("/etc/nginx/nginx.conf")]),e._v(" (trickles down to all site-specific configs in "),s("code",[e._v("/etc/nginx/conf.d/SITEFILE")]),e._v(")")]),e._v(" "),s("p",[s("code",[e._v("gzip on")]),e._v(" - Enable compression."),s("br"),e._v(" "),s("code",[e._v("gzip_min_length 512")]),e._v(" - Only compress files bigger than 512 bytes."),s("br"),e._v(" "),s("code",[e._v("gzip_types text/plain application/javascript text/html text/css;")]),e._v(" - Formats to compress."),s("br"),e._v(" "),s("code",[e._v("gzip_vary")]),e._v(" - Sends vary header.")]),e._v(" "),s("p",[e._v("It's important to use the "),s("code",[e._v("Vary")]),e._v(" option in order to prevent compressed and non-compressed responses from interfering with each other i.e. two browsers download gzipped content, while only one supports it, resulting in only it being cached, making that response unusable to other non-supporting browsers.")]),e._v(" "),s("h1",{attrs:{id:"php-interpreter-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#php-interpreter-setup","aria-hidden":"true"}},[e._v("#")]),e._v(" PHP Interpreter Setup")]),e._v(" "),s("p",[e._v("Nginx only understands static files. It doesn't know how to handle code. For that, we use an interpreter (sits behind the web-server), which communicates with nginx via a socket file.")]),e._v(" "),s("ol",[s("li",[s("code",[e._v("apt-get install php-mysql php-fpm")]),e._v(". - Install the interpreter.\n"),s("ul",[s("li",[s("strong",[e._v("FastCGI Process Manager")]),e._v(" is used to create a pool of PHP interpreter processes waiting to deal with web-server requests. Without this, there would be only one process which would handle requests one by one, resulting in long wait times.")])])]),e._v(" "),s("li",[s("code",[e._v("apt-get install php-json php-xmlrpc php-curl php-gd php-xml")]),e._v(" - Install extra extensions needed for Wordpress.")]),e._v(" "),s("li",[s("code",[e._v("mkdir /var/run/php-fpm")]),e._v(" - Create directory for php-fpm sockets (webserver -> PHP)")]),e._v(" "),s("li",[s("code",[e._v("ls /etc/php/7.0/fpm/pool.d")]),e._v(" - Check if the pool configurations directory exists. If not, create it.")]),e._v(" "),s("li",[e._v("Configure "),s("code",[e._v("/etc/php/7.0/fpm/php-fpm.conf")]),e._v(":\n"),s("ul",[s("li",[e._v("Make a backup copy.")]),e._v(" "),s("li",[e._v("Add "),s("strong",[e._v("just")]),e._v(" the following inside:"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[global]\npid = /run/php-fpm.pid\nerror_log = /var/log/php-fpm.log\ninclude = /etc/php/fpm/pool.d/*.conf\n")])])])])])]),e._v(" "),s("li",[e._v("Create a default pool configuration in "),s("code",[e._v("/etc/php/7.0/fpm/pool.d/www.conf")]),e._v(":\n"),s("ul",[s("li",[e._v("Make a backup copy.")]),e._v(" "),s("li",[e._v("Add "),s("strong",[e._v("just")]),e._v(" the following inside to define a private socket between nginx and the interpreter i.e. www-data from nginx communicates with www-data from fpm:"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[default]\nsecurity.limit_extensions = .php\nlisten = /var/run/php/yourserverhostname.sock\nlisten.owner = www-data\nlisten.group = www-data\nlisten.mode = 0660\nuser = www-data\ngroup = www-data\npm = dynamic\npm.max_children = 75\npm.start_servers = 8\npm.min_spare_servers = 5\npm.max_spare_servers = 20\npm.max_requests = 500\n")])])])])])]),e._v(" "),s("li",[e._v("Edit the top level php.ini file in "),s("code",[e._v("/etc/php/7.0/fpm/php.ini")]),e._v(":\n"),s("ul",[s("li",[e._v("Make a backup copy.")]),e._v(" "),s("li",[e._v("Add "),s("strong",[e._v("just")]),e._v(" the following inside:"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('[PHP]\nengine = On\nshort_open_tag = Off\nasp_tags = Off\nprecision = 14\noutput_buffering = 4096\nzlib.output_compression = Off\nimplicit_flush = Off\nunserialize_callback_func =\nserialize_precision = 17\ndisable_functions =\ndisable_classes =\nzend.enable_gc = On\nexpose_php = Off\nmax_execution_time = 30\nmax_input_time = 60\nmemory_limit = 128M\nerror_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT\ndisplay_errors = Off\ndisplay_startup_errors = Off\nlog_errors = On\nlog_errors_max_len = 1024\nignore_repeated_errors = Off\nignore_repeated_source = Off\nreport_memleaks = On\ntrack_errors = Off\nhtml_errors = On\nvariables_order = "GPCS"\nrequest_order = "GP"\nregister_argc_argv = Off\nauto_globals_jit = On\npost_max_size = 8M\nauto_prepend_file =\nauto_append_file =\ndefault_mimetype = "text/html"\ndefault_charset = "UTF-8"\ndoc_root =\nuser_dir =\nenable_dl = Off\ncgi.fix_pathinfo=0\nfile_uploads = On\nupload_max_filesize = 25M\nmax_file_uploads = 20\nallow_url_fopen = On\nallow_url_include = Off\ndefault_socket_timeout = 60\n[CLI Server]\ncli_server.color = On\n[Date]\n[filter]\n[iconv]\n[intl]\n[sqlite]\n[sqlite3]\n[Pcre]\n[Pdo]\n[Pdo_mysql]\npdo_mysql.cache_size = 2000\npdo_mysql.default_socket=\n[Phar]\n[mail function]\nSMTP = localhost\nsmtp_port = 25\nmail.add_x_header = On\n[SQL]\nsql.safe_mode = Off\n[ODBC]\nodbc.allow_persistent = On\nodbc.check_persistent = On\nodbc.max_persistent = -1\nodbc.max_links = -1\nodbc.defaultlrl = 4096\nodbc.defaultbinmode = 1\n[Interbase]\nibase.allow_persistent = 1\nibase.max_persistent = -1\nibase.max_links = -1\nibase.timestampformat = "%Y-%m-%d %H:%M:%S"\nibase.dateformat = "%Y-%m-%d"\nibase.timeformat = "%H:%M:%S"\n[MySQL]\nmysql.allow_local_infile = On\nmysql.allow_persistent = On\nmysql.cache_size = 2000\nmysql.max_persistent = -1\nmysql.max_links = -1\nmysql.default_port =\nmysql.default_socket =\nmysql.default_host =\nmysql.default_user =\nmysql.default_password =\nmysql.connect_timeout = 60\nmysql.trace_mode = Off\n[MySQLi]\nmysqli.max_persistent = -1\nmysqli.allow_persistent = On\nmysqli.max_links = -1\nmysqli.cache_size = 2000\nmysqli.default_port = 3306\nmysqli.default_socket =\nmysqli.default_host =\nmysqli.default_user =\nmysqli.default_pw =\nmysqli.reconnect = Off\n[mysqlnd]\nmysqlnd.collect_statistics = On\nmysqlnd.collect_memory_statistics = Off\n[OCI8]\n[PostgreSQL]\npgsql.allow_persistent = On\npgsql.auto_reset_persistent = Off\npgsql.max_persistent = -1\npgsql.max_links = -1\npgsql.ignore_notice = 0\npgsql.log_notice = 0\n[Sybase-CT]\nsybct.allow_persistent = On\nsybct.max_persistent = -1\nsybct.max_links = -1\nsybct.min_server_severity = 10\nsybct.min_client_severity = 10\n[bcmath]\nbcmath.scale = 0\n[browscap]\n[Session]\nsession.save_handler = files\nsession.use_strict_mode = 0\nsession.use_cookies = 1\nsession.use_only_cookies = 1\nsession.name = PHPSESSID\nsession.auto_start = 0\nsession.cookie_lifetime = 0\nsession.cookie_path = /\nsession.cookie_domain =\nsession.cookie_httponly =\nsession.serialize_handler = php\nsession.gc_probability = 1\nsession.gc_divisor = 1000\nsession.gc_maxlifetime = 1440\nsession.referer_check =\nsession.cache_limiter = nocache\nsession.cache_expire = 180\nsession.use_trans_sid = 0\nsession.hash_function = 0\nsession.hash_bits_per_character = 5\nurl_rewriter.tags = "a=href,area=href,frame=src,input=src,form=fakeentry"\n[MSSQL]\nmssql.allow_persistent = On\nmssql.max_persistent = -1\nmssql.max_links = -1\nmssql.min_error_severity = 10\nmssql.min_message_severity = 10\nmssql.compatibility_mode = Off\nmssql.secure_connection = Off\n[Assertion]\n[COM]\n[mbstring]\n[gd]\n[exif]\n[Tidy]\ntidy.clean_output = Off\n[soap]\nsoap.wsdl_cache_enabled=1\nsoap.wsdl_cache_dir="/tmp"\nsoap.wsdl_cache_ttl=86400\nsoap.wsdl_cache_limit = 5\n[sysvshm]\n[ldap]\nldap.max_links = -1\n[dba]\n[opcache]\n[curl]\n[openssl]\n')])])])])])]),e._v(" "),s("li",[s("code",[e._v("cgi.fix_pathinfo=0")]),e._v(" - "),s("strong",[e._v("Make sure this is set!")])])])])},[],!1,null,null,null);t.default=a.exports}}]);